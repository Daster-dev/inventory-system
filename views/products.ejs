<%- include('partials/header') %>





<div class="form-box">
  <h2>â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h2>
  <form action="/products/add" method="POST" id="productForm" class="ffffffffffffff">
    <div class="form-box-div">
    <div class="form-row a">
      <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:</label>
      <input type="text" name="name" required>
    </div>

    <div class="form-row b">
      <label>Ø§Ù„Ù‚Ø³Ù…:</label>
        <input name="category" required>
    </div>

    <div class="form-row c">
      <label>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡:</label>
      <input type="number" name="priceIn" step="0.01" required>
    </div>

    <div class="form-row d">
      <label>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹:</label>
      <input type="number" name="priceOut" step="0.01" required>
    </div>

    <div class="form-row e">
      <label>Ø§Ù„ÙƒÙ…ÙŠØ©:</label>
      <input type="number" name="qty" required>
    </div>

    <div class="form-row h">
      <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡:</label>
      <input type="date" name="expiryDate">
    </div>

    <div class="form-row i">
      <label>ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬:</label>

	<input type="file" id="imgInput" accept="image/*" required>
  <input type="hidden" name="imgPath" id="imgPath">
Ø¬
    </div>
	
	
	<div class="form-row j">
      <label>Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯:</label>
      <input type="text" name="barcode" id="barcodeInput" required>
	    <button type="button" onclick="startScanner()">ğŸ“· Ø§Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</button>
	    <button type="button" style="display: none;" id="closeBTN">close</button>
        <div id="scanner" style="width:300px; display:none;"></div>
    </div>
	
    </div>
    <button type="submit" class="form-submit">ğŸ“¦ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬</button>
  </form>
</div>

<br>
<hr>




<h1>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ØªÙˆÙØ±Ø©</h1>
<small style="display: inline-block; margin: 10px; color: #ccc;">
  <span style="display: inline-block; width: 12px; height: 12px; background-color: #4caf50; border-radius: 50%; margin-right: 6px;"></span>
  Ø§Ù„Ù…Ù†ØªØ¬ Ù…ØªÙˆÙØ± Ø¨Ø´ÙƒÙ„ Ø¬ÙŠØ¯
</small>
<br>
<small style="display: inline-block; margin: 10px; color: #ccc;">
  <span style="display: inline-block; width: 12px; height: 12px; background-color: #ffc107; border-radius: 50%; margin-right: 6px;"></span>
  Ø§Ù„Ù…Ù†ØªØ¬ Ø¹Ù„Ù‰ ÙˆØ´Ùƒ Ø§Ù„Ù†ÙØ§Ø¯
</small>
<form id="searchForm" style="margin: 15px 0;">
  <input type="text" id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬..." style="padding: 8px; width: 250px;">
</form>

  	    <button type="button" onclick="startScanner2()">ğŸ“· Ø§Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</button>
		<button type="button" id="closeBTN2"> close</button>
        <div id="scanner2" style="width:300px; display:none;"></div>
        <br>
		<button id="showOutOnly" style="margin:10px;">ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© Ø§Ù„ÙƒÙ…ÙŠØ©</button>
<button id="showAll" style="margin:10px; display:none;">â†©ï¸ Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>

        <br>
<select id="filterCategory">
  <option value="" <%= !category ? 'selected' : '' %>>ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
  <% categories.forEach(c => { %>
    <option value="<%= c %>" <%= (c === category) ? 'selected' : '' %>><%= c %></option>
  <% }) %>
</select>


<div id="outOfStockView" style="display:none;">
  <h2>ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©</h2>
  <div id="outOfStockList"></div>
</div>

<div id="productList">
  <% products.forEach(p => { %>
    <div class="product-card 
  <% if (p.qty === 0) { %> out <% } 
     else if (p.qty < 5) { %> low <% } 
     else { %> ok <% } %>" data-name="<%= p.name.toLowerCase() || '' %>" data-barcode="<%= p.barcode || '' %>">
<% if (p.imgPath) { %>
    <img src="<%- p.imgPath %>" alt="<%= p.name %>" id="imgClick">
  <% }; %>
 

  <h3><%= p.name %></h3>

  <p>Ø§Ù„Ù‚Ø³Ù…: <strong><%= p.category %></strong></p>
  <p>Ø§Ù„ÙƒÙ…ÙŠØ©: <%= p.qty %></p>

  <button class="sell-btn" data-id="<%= p.id %>">ØªÙ… Ø§Ù„Ø¨ÙŠØ¹</button>
<form action="/return-product" method="POST" style="display:inline;">
  <input type="hidden" name="productId" value="<%= p.id %>">
  <button type="submit">â†©ï¸ Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ù†ØªØ¬</button>
</form>

  <form action="/products/delete/<%= p.id %>" method="POST" style="margin-top:5px;" onsubmit="return confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ØŸ');">
    <button type="submit" class="del-btn" style="background:#c00; color:#fff;">ğŸ—‘ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬</button>
  </form>


</div>

  <% }) %>
</div>


<script src="/js/main.js"></script>


<script src="https://unpkg.com/html5-qrcode"></script>
<script>
function closeCam(){
  document.getElementById("scanner").style.display = "none";
  document.getElementById("closeBTN").style.display = "none";
}
function closeCam2(){
  document.getElementById("scanner2").style.display = "none";
  document.getElementById("closeBTN2").style.display = "none";
}
  function startScanner() {
  document.getElementById("closeBTN").style.display = "block";
    document.getElementById("scanner").style.display = "block";
    const scanner = new Html5Qrcode("scanner");
    scanner.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      (decodedText) => {
        scanner.stop();
        document.getElementById("barcodeInput").value = decodedText;
        document.getElementById("scanner").style.display = "none";
      },
      (errorMessage) => {
        console.warn("Ø®Ø·Ø£ Ø¨Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©:", errorMessage);
      }
    );
document.getElementById('closeBTN').addEventListener('click', async () => {
  try {
    await scanner.stop();
    document.getElementById("scanner").style.display = "none";
    document.getElementById("closeBTN").style.display = "none";
  } catch (err) {
    console.error('âŒ ÙØ´Ù„ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§:', err);
  }
});
  }
  
  function startScanner2() {
  document.getElementById("closeBTN2").style.display = "block";
    document.getElementById("scanner2").style.display = "block";
    const scanner = new Html5Qrcode("scanner2");
    scanner.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      (decodedText) => {
        scanner.stop();
		const searchInput = document.getElementById("searchInput");
        searchInput.value = decodedText;
		    const event = new Event('input', { bubbles: true });
            searchInput.dispatchEvent(event);
        document.getElementById("scanner2").style.display = "none";
      },
      (errorMessage) => {
        console.warn("Ø®Ø·Ø£ Ø¨Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©:", errorMessage);
      }
    );
document.getElementById('closeBTN2').addEventListener('click', async () => {
  try {
    await scanner.stop();
    document.getElementById("scanner2").style.display = "none";
    document.getElementById("closeBTN2").style.display = "none";
  } catch (err) {
    console.error('âŒ ÙØ´Ù„ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§:', err);
  }
});
  }

</script>

<script>
document.getElementById('productForm').addEventListener('submit', async function (event) {
  event.preventDefault();

  const fileInput = document.getElementById('imgInput');
  const base64Input = document.getElementById('imgPath');
  const form = event.target;

  if (fileInput.files.length === 0) return form.submit(); // Ù…Ø§ÙƒÙˆ ØµÙˆØ±Ø©

  try {
    const file = fileInput.files[0];
    const base64 = await toBase64(file);
    base64Input.value = base64;

    form.submit(); // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ø¹Ø¯ ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØµÙˆØ±Ø©
  } catch (error) {
    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©');
    console.error(error);
  }
});

function toBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();

    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;

    reader.readAsDataURL(file); // ÙŠØ­ÙˆÙ‘Ù„ Ø§Ù„ØµÙˆØ±Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¥Ù„Ù‰ Base64
  });
}
</script>
<script>
document.getElementById('productForm').addEventListener('submit', async function (event) {
  event.preventDefault();

  const fileInput = document.getElementById('imgInput');
  const imgPathInput = document.getElementById('imgPath');
  const form = event.target;

  const file = fileInput.files[0];
  const formData = new FormData();
  formData.append('file', file);
  formData.append('upload_preset', 'ml_default'); // Ø§Ø®ØªÙŠØ§Ø±ÙŠ
  formData.append('publicKey', 'public_GvPxhVqMH6xA5PdJJkO/OIxaDIs='); // Ø§Ø³ØªØ¨Ø¯Ù„Ù‡Ø§ Ø¨Ù…ÙØªØ§Ø­Ùƒ
  formData.append('fileName', file.name);

  try {
    const res = await fetch('https://upload.imagekit.io/api/v1/files/upload', {
      method: 'POST',
      headers: {
        Authorization: 'Basic ' + btoa('public_GvPxhVqMH6xA5PdJJkO/OIxaDIs=')
      },
      body: formData
    });

    const data = await res.json();
	
	if (res.ok && data.url) {
    imgPathInput.value = data.url;
    form.submit();
  } else {
    console.error('âŒ Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹Ø© Ù…Ù† ImageKit:', data);
    alert('1ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©: ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ÙØªØ§Ø­ Ø£Ùˆ Ø§Ù„Ù…Ù„Ù');
  }
  } catch (error) {
    console.error('âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ ImageKit:', error);
  }
});
</script>
<script>
document.getElementById('showOutOnly').addEventListener('click', () => {
  const cards = document.querySelectorAll('.product-card');

  cards.forEach(card => {
    if (card.classList.contains('out')) {
      card.style.opacity = '1';
      card.style.pointerEvents = 'auto';
    } else {
      card.style.opacity = '0';
      card.style.pointerEvents = 'none';
    }
  });

  document.getElementById('showOutOnly').style.display = 'none';
  document.getElementById('showAll').style.display = 'inline-block';
});

document.getElementById('showAll').addEventListener('click', () => {
  const cards = document.querySelectorAll('.product-card');

  cards.forEach(card => {
    card.style.opacity = '1';
    card.style.pointerEvents = 'auto';
  });

  document.getElementById('showOutOnly').style.display = 'inline-block';
  document.getElementById('showAll').style.display = 'none';
});
</script>



<%- include('partials/footer') %>
