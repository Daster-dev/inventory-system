<%- include('partials/header') %>





<div class="form-box">
  <h2>โ ุฅุถุงูุฉ ููุชุฌ ุฌุฏูุฏ</h2>
  <form action="/products/add" onsubmit="prepareImage(event)" method="POST" enctype="multipart/form-data" class="ffffffffffffff">
    <div class="form-box-div">
    <div class="form-row a">
      <label>ุงุณู ุงูููุชุฌ:</label>
      <input type="text" name="name" required>
    </div>

    <div class="form-row b">
      <label>ุงููุณู:</label>
        <input name="category" required>
    </div>

    <div class="form-row c">
      <label>ุณุนุฑ ุงูุดุฑุงุก:</label>
      <input type="number" name="priceIn" step="0.01" required>
    </div>

    <div class="form-row d">
      <label>ุณุนุฑ ุงูุจูุน:</label>
      <input type="number" name="priceOut" step="0.01" required>
    </div>

    <div class="form-row e">
      <label>ุงููููุฉ:</label>
      <input type="number" name="qty" required>
    </div>

    <div class="form-row h">
      <label>ุชุงุฑูุฎ ุงูุงูุชูุงุก:</label>
      <input type="date" name="expiryDate">
    </div>

    <div class="form-row i">
      <label>ุตูุฑุฉ ุงูููุชุฌ:</label>

	  <input type="file" id="imgInput" accept="image/*">
      <input type="hidden" name="imgBase64" id="imgBase64">
    </div>
	
	
	<div class="form-row j">
      <label>ุงูุจุงุฑููุฏ:</label>
      <input type="text" name="barcode" id="barcodeInput" required>
	    <button type="button" onclick="startScanner()">๐ท ุงูุณุญ ุงูุจุงุฑููุฏ</button>
        <div id="scanner" style="width:300px; display:none;"></div>
    </div>
	
    </div>
    <button type="submit" class="form-submit">๐ฆ ุฅุถุงูุฉ ุงูููุชุฌ</button>
  </form>
</div>

<br>
<hr>




<h1>ุงูููุชุฌุงุช ุงููุชููุฑุฉ</h1>
<small style="display: inline-block; margin: 10px; color: #ccc;">
  <span style="display: inline-block; width: 12px; height: 12px; background-color: #4caf50; border-radius: 50%; margin-right: 6px;"></span>
  ุงูููุชุฌ ูุชููุฑ ุจุดูู ุฌูุฏ
</small>
<br>
<small style="display: inline-block; margin: 10px; color: #ccc;">
  <span style="display: inline-block; width: 12px; height: 12px; background-color: #ffc107; border-radius: 50%; margin-right: 6px;"></span>
  ุงูููุชุฌ ุนูู ูุดู ุงูููุงุฏ
</small>
<form id="searchForm" style="margin: 15px 0;">
  <input type="text" id="searchInput" placeholder="๐ ุงุจุญุซ ุนู ููุชุฌ..." style="padding: 8px; width: 250px;">
</form>

  	    <button type="button" onclick="startScanner2()">๐ท ุงูุณุญ ุงูุจุงุฑููุฏ</button>
        <div id="scanner2" style="width:300px; display:none;"></div>
  
  <br>
<select id="filterCategory">
  <option value="" <%= !category ? 'selected' : '' %>>ูู ุงูุฃูุณุงู</option>
  <% categories.forEach(c => { %>
    <option value="<%= c %>" <%= (c === category) ? 'selected' : '' %>><%= c %></option>
  <% }) %>
</select>



<div id="productList">
  <% products.forEach(p => { %>
    <div class="product-card 
  <% if (p.qty === 0) { %> out <% } 
     else if (p.qty < 5) { %> low <% } 
     else { %> ok <% } %>" data-name="<%= p.name.toLowerCase() || '' %>" data-barcode="<%= p.barcode || '' %>">
<% if (p.imgPath && p.imgPath.startsWith('data:image')) { %>
    <img src="<%= p.imgPath %>" alt="<%= p.name %>" id="imgClick">
  <% } else { %>
  <p>๐ท ูุง ุชูุฌุฏ ุตูุฑุฉ</p>
<% } %>
  <h3><%= p.name %></h3>
  <pre><%= p.imgPath.slice(0, 100) %></pre>


  <p>ุงููุณู: <strong><%= p.category %></strong></p>
  <p>ุงููููุฉ: <%= p.qty %></p>

  <button class="sell-btn" data-id="<%= p.id %>">ุชู ุงูุจูุน</button>
<form action="/return-product" method="POST" style="display:inline;">
  <input type="hidden" name="productId" value="<%= p.id %>">
  <button type="submit">โฉ๏ธ ุฅุฑุฌุงุน ุงูููุชุฌ</button>
</form>

  <form action="/products/delete/<%= p.id %>" method="POST" style="margin-top:5px;" onsubmit="return confirm('โ๏ธ ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุงูููุชุฌุ');">
    <button type="submit" class="del-btn" style="background:#c00; color:#fff;">๐ ุญุฐู ุงูููุชุฌ</button>
  </form>


</div>

  <% }) %>
</div>


<script src="/js/main.js"></script>


<script src="https://unpkg.com/html5-qrcode"></script>
<script>
  function startScanner() {
    document.getElementById("scanner").style.display = "block";
    const scanner = new Html5Qrcode("scanner");
    scanner.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      (decodedText) => {
        scanner.stop();
        document.getElementById("barcodeInput").value = decodedText;
        document.getElementById("scanner").style.display = "none";
      },
      (errorMessage) => {
        console.warn("ุฎุทุฃ ุจุงููุฑุงุกุฉ:", errorMessage);
      }
    );
  }
  
  function startScanner2() {
    document.getElementById("scanner2").style.display = "block";
    const scanner = new Html5Qrcode("scanner2");
    scanner.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      (decodedText) => {
        scanner.stop();
		const searchInput = document.getElementById("searchInput");
        searchInput.value = decodedText;
		
		
		    const event = new Event('input', { bubbles: true });
            searchInput.dispatchEvent(event);
        document.getElementById("scanner2").style.display = "none";
      },
      (errorMessage) => {
        console.warn("ุฎุทุฃ ุจุงููุฑุงุกุฉ:", errorMessage);
      }
    );
  }
  
  
  
    function prepareImage() {
    const fileInput = document.getElementById('imgInput');
    const hiddenInput = document.getElementById('imgBase64');

    if (fileInput.files.length > 0) {
      const reader = new FileReader();
      reader.onload = function(e) {
        hiddenInput.value = e.target.result; // Base64 string
        document.forms[0].submit(); // ุฅุฑุณุงู ุงููููุฐุฌ ุจุนุฏ ุชุฌููุฒ ุงูุตูุฑุฉ
      };
      reader.readAsDataURL(fileInput.files[0]);
      event.preventDefault(); // ูููู ุงูุฅุฑุณุงู ูุญูู ุชุฌููุฒ ุงูุตูุฑุฉ
    }
  }
</script>



<%- include('partials/footer') %>
